name: Release Dispatcher

on:
  workflow_call:
    inputs:
      dry-run:
        description: Run in dry-run mode (preview only)
        type: boolean
        default: false
    secrets:
      APP_ID:
        required: true
      APP_PRIVATE_KEY:
        required: true
      SAVVYWEB_NPM_AUTH_TOKEN:
        required: false

jobs:
  control:
    name: Detect Phase
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      phase: ${{ steps.control.outputs.phase }}
      should_continue: ${{ steps.control.outputs.should_continue }}
      has_changesets: ${{ steps.control.outputs.has_changesets }}
      is_release_commit: ${{ steps.control.outputs.is_release_commit }}
      merged_pr_number: ${{ steps.control.outputs.merged_pr_number }}
      is_pr_event: ${{ steps.context.outputs.is_pr_event }}
      is_pr_merged: ${{ steps.context.outputs.is_pr_merged }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Detect workflow phase
        id: control
        uses: savvy-web/workflow-control-action@main

      - name: Set context flags
        id: context
        run: |
          echo "is_pr_event=${{ github.event_name == 'pull_request' }}" >> $GITHUB_OUTPUT
          echo "is_pr_merged=${{ github.event.pull_request.merged == true }}" >> $GITHUB_OUTPUT

  branch-management:
    name: Branch Management
    needs: control
    if: needs.control.outputs.phase == 'branch-management'
    uses: spencerbeggs/.github/.github/workflows/release-branch.yml@main
    with:
      dry-run: ${{ inputs.dry-run }}
    secrets: inherit

  validation:
    name: Validation
    needs: control
    if: |
      needs.control.outputs.is_pr_event == 'true' &&
      needs.control.outputs.is_pr_merged != 'true'
    uses: spencerbeggs/.github/.github/workflows/release-validate.yml@main
    with:
      phase: ${{ needs.control.outputs.phase }}
      dry-run: ${{ inputs.dry-run }}
    secrets: inherit

  publish:
    name: Publish
    needs: control
    if: needs.control.outputs.phase == 'publishing' || needs.control.outputs.phase == 'close-issues'
    uses: spencerbeggs/.github/.github/workflows/release-publish.yml@main
    with:
      phase: ${{ needs.control.outputs.phase }}
      dry-run: ${{ inputs.dry-run }}
    secrets: inherit
